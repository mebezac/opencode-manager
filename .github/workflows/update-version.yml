name: Update Version

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  update-version:
    if: ${{ !github.event.release.draft }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from tag
        id: version
        run: |
          TAG_NAME="${{ github.event.release.tag_name }}"
          VERSION="${TAG_NAME#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Extracted version: ${VERSION} from tag ${TAG_NAME}"

      - name: Update package.json version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Updating package.json to version ${VERSION}"
          
          # Use jq to update the version field
          jq --arg version "${VERSION}" '.version = $version' package.json > package.json.tmp
          mv package.json.tmp package.json
          
          echo "Updated package.json:"
          cat package.json | jq -r '.version'

      - name: Check if changes exist
        id: check
        run: |
          if git diff --quiet package.json; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes detected in package.json"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected in package.json"
          fi

      - name: Commit and push version update
        if: steps.check.outputs.changed == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add package.json
          git commit -m "chore: bump version to ${VERSION} [skip ci]"
          git push origin main

      - name: Update release tag to point to new commit
        if: steps.check.outputs.changed == 'true'
        run: |
          TAG_NAME="${{ github.event.release.tag_name }}"
          
          # Delete the tag locally and remotely
          git tag -d "${TAG_NAME}" || true
          git push origin ":refs/tags/${TAG_NAME}" || true
          
          # Create new tag pointing to the updated commit
          git tag -a "${TAG_NAME}" -m "Release ${TAG_NAME}"
          git push origin "${TAG_NAME}"
          
          echo "Updated tag ${TAG_NAME} to point to new commit with version update"
